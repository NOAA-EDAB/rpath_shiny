#GOM model by Sarah Weisberg

library(Rpath); library(data.table); library(here)

#load(here("GOM_Rpath.RData"))  #GOM, the balanced model stored locally

load(here("GOM_params_Rpath.RData"))  #GOM.params, stored locally

# gom.groups <- unname(GOM$Group)
# 
# gom.type <- unname(GOM$type)
# 
# gom.par <- create.rpath.params(gom.groups, gom.type)
# 
# gom.par$model[, Biomass := unname(GOM$Biomass)]
# 
# gom.par$model[, PB := unname(GOM$PB)]
# 
# gom.par$model[, QB := unname(GOM$QB)]
# 
# #float path_EE[NUM_GROUPS+1] = { 1, 0.8798624, 0.8832949, 0.9413487, 0.9117724, 0.7440153, 0.9114986, 0.8848614, 0.8999999, 0.8819566, 0.8633214, 0.8862541, 0.8823805, 0.8879386, 0.8046172, 0.8990406, 0.8963319, 0.9790097, 0.9941966, 0.5794412, 0.8889518, 0.9287031, 0.910743,  0.878319, 0.8430014, 0.8114244, 0.2865187, 0.01683634, 0.1337793, 0.1249854, 0.005459445, 0.9885055, 0};
# gom.par$model[, BioAcc := unname(GOM$BA)]
# 
# gom.par$model[, Unassim := unname(GOM$Unassim)]
# 
# #float path_DtImp[NUM_GROUPS+1] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
# 
# gom.par$model[, Discard := c(rep(0, 66), 1)]
# gom.par$model[, Detritus := unname(GOM$DetFate)]

########## Below here not changed
#### Could read in fisheries and discards as separate columns
# 
# gom.par$model[, Fishery := GOM$Landings]
# 
# gom.par$model[, Fishery.disc := GOM$Discard]
# 
# DC.groups <- gom.groups[which(!gom.groups %in% c('Discard', 'Detritus-POC', 'Fishery'))]
# 
# DC.c.code <-as.data.table(matrix(c(
#   0,0,0.4305193,0.2117425,0.7240587,0.6317893,0.08602893,0.1824,0.1241,0.1351713,0.4000163,0.2008283,0.7909901,0,0.07548419,0.0589119,0.01121766,0.1656693,0,0.0117771,0,0,0,0,0,0,0,0,0,0,0,0,0,
#   0,0,0,0.1971663,0,0,0.02000673,0,0.2954761,0.1374624,0.1951299,0.2008283,0.1188099,0.1418395,0.4473137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
#   0,0,0,0.09702543,0.1133734,0.04287973,0.05001682,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
#   0,0,0,0,0.032,0.1097328,0.3301111,0.2208001,0,0.005453273,0,0,0,0,0,0.4305102,0.1193151,0.08079781,0,0.05613042,0,0,0,0,0,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0.1276366,0.3601212,0.3664,0,0.02749248,0,0,0,0,0,0.2492427,0.4344292,0.676395,0.1006037,0.9020878,0,0,0,0,0.03340645,0,0,0.153928,0,0.03427451,0,0,0,
#   0,0,0,0,0,0.02392604,0.04867304,0,0,0,0,0,0,0,0,0,0.01923198,0.02177701,0,0,0.01960942,0.008961361,0.08314439,0.04308448,0,0.09437622,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0.0464,0.05909523,0.05383944,0.03414774,0.06733654,0,0,0.1509684,0.06797528,0.2172146,0.04431918,0.5030184,0.02034226,0,0.06147739,0.0328972,0.02203885,0,0,0.00313569,0.5024855,0.000274618,0.1405256,0,0,0,
#   0,0,0,0,0,0,0,0,0.02672455,0.1351713,0,0.06561421,0,0.07919377,0,0.02096442,0.01121766,0,0,0.001553198,0,0.1471426,0.1663658,0.01101942,0,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0.000327961,0,0,0.004904852,0.03310977,0,0.009938519,0,0.066255,0.008152554,0.01274636,0.0545647,0.000721625,0.1509055,0.002170789,0.01226363,0.1844322,0.1663658,0.01101942,0.01113548,0,0.005412052,0,0.002591398,0,0,0,0,
#   0,0,0,0,0,0,0,0,0.000639306,0.02196813,0.004286418,0.02239663,0,0.2375813,0,0.005,0.00803651,0.00072132,0,0,0,0.1229548,0.1663658,0.03305828,0,0,0.005412052,0,0.002591398,0,0,0,0,
#   0,0,0,0,0,0.001748159,0,0,0.02106318,0.1346288,0.022337,0.0363167,0,0.2375813,0.1048391,0.02096442,0.01121766,0.002212085,0.01676727,0,0.01226363,0.1844322,0.1109106,0.1091925,0.01113548,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0.001053159,0.004799868,0.002984548,0.001145771,0,0.009741648,0,0,0,0,0,0,0,0.05240696,0.04041656,0.01101942,0,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0.001404212,0.004421631,0.000735662,0.006267365,0,0.04154278,0,0,0,0,0,0,0.1941741,0.09574349,0.1109106,0.02203885,0,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001258382,0,0,0,0.02361985,0,0.01720621,0.01696089,0.003024275,0.1207828,0,0,0.00313569,0,0.000274618,0.02157306,0,0,0,
#   0,0,0,0,0,0,0.004059562,0,0,0,0,0,0,0,0,0.0747728,0.1080974,0.00738653,0.1676727,0.005938409,0.01226363,0,0.01127904,0.01101942,0,0,0,0,0,0.10,0,0,0,
#   0,0,0,0,0,0,0.000358531,0,0,0,0,0,0,0,0,0,0,0,0.0075355,0,0.3638209,0.04829028,0.04365378,0.2704768,0.2338451,0.1801901,0.1359761,0.1550972,0.2288119,0.3118983,0,0,0,
#   0,0,0,0,0,0,0.000454902,0,0,0,0,0,0,0,0,0,0,0,0.007557068,0,0.03679087,0.002015652,0.001879841,0.0560989,0.05567741,0.7006319,0.256553,0.08101361,0.06583849,0.2684838,0,0,0,
#   0,0,0,0,0,0,9.18E-05,0,0,0,0,0,0,0,0,0,0,0,0.02131235,0,0.02591145,0.003626702,0.001691515,0.04413503,0.1781677,0.02480174,0.06566829,0.03142953,0.3652223,0.03182262,0,0,0,
#   0,0,0,0,0,0,4.37E-05,0,0,0,0,0,0,0,0,0,0,0,0.001007609,0,0.01925174,0,0,0.001604244,0.02227096,0,0,0,0,0.02017987,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.000721882,0,0,0,0.031213,0,0,0,0,0.000353094,0,0,0,
#   0,0,0,0,0,0,0,0,0,0.001607866,0,0.00181822,0,0.002898938,0,0,0.001819155,0,0,0,0.1216143,0.03728956,0.01221896,0.01101942,0.05567741,0,0.251599,0.01532696,0.1114401,0.02,0,0,0,
#   0,0,0,0,0,0,0,0,0,0.000314047,0,0.000115925,0,0.000863633,0,0,0.001819155,0,0,0,0.04249413,0.006046957,0.0093992,0.004007064,0.08908386,0,0.02449874,0.0110239,0.04565654,0.01322618,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0.001225253,0,0.001656536,0,0,0.001819155,0,0,0,0.1216143,0.004031305,0.005639521,0.218385,0.07794838,0,0.2486094,0.04969525,0.1772986,0.02856211,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03340645,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01113548,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03340645,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01113548,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.02227096,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03340645,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0091007,0,0,0,
#   0,0,0.5694807,0.4940658,0.130568,0.06195949,0.1000336,0.184,0.465539226,0.304559621,0.340362397,0.386167839,0.0902,0.18084539,0.21198369,0.0589119,0,0,0,0,0,0.02418782,0.03383712,0,0.05567741,0,0,0,0,0,0,0,0,
#   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0), 32, 33, byrow = T))
# 
# DC.c.code[, V1  := NULL]
# DC.c.code[, V31 := NULL]
# DC.c.code[, V32 := NULL]
# DC.c.code[, V33 := NULL]
# 
# gom.par$diet <- cbind(gom.par$diet[, Group], DC.c.code)
# 
# setnames(gom.par$diet, c(paste('V', 1:30, sep = '')), c('Group', DC.groups))

gom.par <- GOM.params

gom.groups <- gom.par$model$Group

check.rpath.params(gom.par)

#Run model
GOM <- rpath(gom.par, 'Gulf of Maine')

webplot(GOM, highlight = "AtlHerring", labels = T)

#Check sim
gom.base <- rsim.scenario(GOM, gom.par, 1:100)
gom.run <- rsim.run(gom.base)
rsim.plot(gom.run, gom.groups[1:57])

#scenario plots
GOM.b2 <- adjust.fishing(gom.base, parameter = 'ForcedEffort', group = 'Pelagic',
                         value =2, sim.year = 25:100)

GOM.run1 <- rsim.run(GOM.b2)
rsim.plot(GOM.run1, gom.groups[1:57])



